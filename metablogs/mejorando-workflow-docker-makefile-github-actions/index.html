<!doctype html><html i-amphtml-layout i-amphtml-no-boilerplate lang=es transformed="google;v=2" ⚡><head><meta charset=utf-8><style amp-runtime i-amphtml-version=latest></style><meta content="width=device-width,minimum-scale=1,initial-scale=1" name=viewport><meta content="Actualizo el workflow, dockerizo el entorno, creo un Makefile para mantener todos mis scripts ordenados y añado despliegue continuo con Github Actions" name=description><meta content="Metablog #3 - Workflow con docker, makefile y Github actions" property=og:title><meta content=https://asur.dev/metablogs/mejorando-workflow-docker-makefile-github-actions/ property=og:url><meta content="Actualizo el workflow, dockerizo el entorno, creo un Makefile para mantener todos mis scripts ordenados y añado despliegue continuo con Github Actions" property=og:description><meta content=https://asur.dev/images/mejorando-workflow-docker-makefile-github-actions/share-card.jpg property=og:image><meta content=article property=og:type><meta content property=og:site_name><meta content=summary_large_image name=twitter:card><meta content="Metablog #3 - Workflow con docker, makefile y Github actions" name=twitter:title><meta content=https://asur.dev/metablogs/mejorando-workflow-docker-makefile-github-actions/ name=twitter:url><meta content="Actualizo el workflow, dockerizo el entorno, creo un Makefile para mantener todos mis scripts ordenados y añado despliegue continuo con Github Actions" name=twitter:description><meta content=https://asur.dev/images/mejorando-workflow-docker-makefile-github-actions/share-card.jpg name=twitter:image><meta content=@asurbernardo name=twitter:site><meta content=#333 name=theme-color><script async src=https://cdn.ampproject.org/v0.js></script><script async custom-element=amp-analytics src=https://cdn.ampproject.org/v0/amp-analytics-0.1.js></script><script async custom-element=amp-anim src=https://cdn.ampproject.org/v0/amp-anim-0.1.js></script><script async custom-element=amp-iframe src=https://cdn.ampproject.org/v0/amp-iframe-0.1.js></script><script async custom-element=amp-install-serviceworker src=https://cdn.ampproject.org/v0/amp-install-serviceworker-0.1.js></script><script async custom-element=amp-social-share src=https://cdn.ampproject.org/v0/amp-social-share-0.1.js></script><script async custom-element=amp-video src=https://cdn.ampproject.org/v0/amp-video-0.1.js></script><link href=https://asur-dev.cdn.ampproject.org/i/s/asur.dev/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=https://asur-dev.cdn.ampproject.org/i/s/asur.dev/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href rel="dns-prefetch preconnect"><link href=https://asur-dev.cdn.ampproject.org rel="dns-prefetch preconnect"><style amp-custom>*,*::before,*::after{box-sizing:border-box}ul[class],ol[class]{padding:0}body,h1,h2,h3,h4,p,ul[class],ol[class],li,figure,figcaption,blockquote,dl,dd{margin:0}body{min-height:100vh;scroll-behavior:smooth;text-rendering:optimizeSpeed}ul[class],ol[class]{list-style:none}a:not([class]){text-decoration-skip-ink:auto}img{max-width:100%;display:block}input,button,textarea,select{font:inherit}.chroma{background-color:#fff}.chroma .err{color:#a61717;background-color:#e3d2d2}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .k{color:#000;font-weight:700}.chroma .kc{color:#000;font-weight:700}.chroma .kd{color:#000;font-weight:700}.chroma .kn{color:#000;font-weight:700}.chroma .kp{color:#000;font-weight:700}.chroma .kr{color:#000;font-weight:700}.chroma .kt{color:#458;font-weight:700}.chroma .na{color:teal}.chroma .nb{color:#0086b3}.chroma .bp{color:#999}.chroma .nc{color:#458;font-weight:700}.chroma .no{color:teal}.chroma .nd{color:#3c5d5d;font-weight:700}.chroma .ni{color:purple}.chroma .ne{color:#900;font-weight:700}.chroma .nf{color:#900;font-weight:700}.chroma .nl{color:#900;font-weight:700}.chroma .nn{color:#555}.chroma .nt{color:navy}.chroma .nv{color:teal}.chroma .vc{color:teal}.chroma .vg{color:teal}.chroma .vi{color:teal}.chroma .s{color:#d14}.chroma .sa{color:#d14}.chroma .sb{color:#d14}.chroma .sc{color:#d14}.chroma .dl{color:#d14}.chroma .sd{color:#d14}.chroma .s2{color:#d14}.chroma .se{color:#d14}.chroma .sh{color:#d14}.chroma .si{color:#d14}.chroma .sx{color:#d14}.chroma .sr{color:#009926}.chroma .s1{color:#d14}.chroma .ss{color:#990073}.chroma .m{color:#099}.chroma .mb{color:#099}.chroma .mf{color:#099}.chroma .mh{color:#099}.chroma .mi{color:#099}.chroma .il{color:#099}.chroma .mo{color:#099}.chroma .o{color:#000;font-weight:700}.chroma .ow{color:#000;font-weight:700}.chroma .c{color:#998;font-style:italic}.chroma .ch{color:#998;font-style:italic}.chroma .cm{color:#998;font-style:italic}.chroma .c1{color:#998;font-style:italic}.chroma .cs{color:#999;font-weight:700;font-style:italic}.chroma .cp{color:#999;font-weight:700;font-style:italic}.chroma .cpf{color:#999;font-weight:700;font-style:italic}.chroma .gd{color:#000;background-color:#fdd}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#a00}.chroma .gh{color:#999}.chroma .gi{color:#000;background-color:#dfd}.chroma .go{color:#888}.chroma .gp{color:#555}.chroma .gs{font-weight:700}.chroma .gu{color:#aaa}.chroma .gt{color:#a00}.chroma .gl{text-decoration:underline}.chroma .w{color:#bbb}body{display:grid;grid-template-columns:repeat(12,1fr);grid-gap:1em 1em;font-size:1.2em;font-family:Courier New;line-height:2;color:#333}.header,.main,.footer{grid-column:4/span 6}.header{margin-top:1em}.header__menu{margin:0;padding:0;display:flex;overflow:auto;justify-content:flex-start;border:1px solid #333}.header__menu a{border-bottom:none}.header__menu a:hover{color:#d14}.header__menu__logo{line-height:0}.header__menu__logo svg{width:75px;height:75px;min-width:75px;min-height:75px}.header__menu__list{display:flex;flex-grow:1;flex-wrap:nowrap;align-items:center;justify-content:space-around}.header__menu__list li{padding:0 1em;display:inline}.main{min-height:80vh}.main .pagination{margin:2em auto;display:flex;justify-content:space-between}.main .pagination a{border-bottom:none}.main .pagination a:hover{color:#d14}.footer{display:flex;justify-content:space-between;flex-wrap:wrap}h1,h2,h3,h4{font-family:Helvetica;line-height:1.5}h1{font-size:4rem}h2{font-size:2.5rem}h3{font-size:2rem}h4{font-size:1.5rem}a{color:inherit;text-decoration:none;border-bottom:2px dashed #37474f;transition:background .3s}a:hover{border-color:#d14}li{margin-top:.25em}pre,code{font-family:lucida console,Monaco,monospace;font-size:12pt;background-color:#f1f1f1}blockquote{margin:inherit auto;margin-left:1em;padding:1em;border-left:5px solid #999}blockquote:before{display:none}blockquote:not(:first-of-type){margin-top:.5em}blockquote p{color:#555;font-size:1.25em;font-family:times new roman,serif}#tags{margin:0;padding:0}#tags li{display:inline}.content,.summary{width:100%}.content>*,.summary>*{margin-top:1.5em}.content>h1,.summary>h1{margin-top:.5em}.content pre,.summary pre{overflow:auto;padding:1em}.content code,.summary code{padding:.1em}.content table,.summary table{display:block;overflow-x:auto;border-collapse:collapse}.content table td,.content table th,.summary table td,.summary table th{border:1px solid #ddd}.content table td,.summary table td{padding:.5em 1em}.content table th,.summary table th{padding:1em 2em;background-color:#333;color:#fff}.content table tr:nth-child(even),.summary table tr:nth-child(even){background-color:#f1f1f1}.content table tr:hover,.summary table tr:hover{background-color:#ddd}.content .highlight,.summary .highlight{overflow:auto}.content .highlight .chroma,.summary .highlight .chroma{background-color:#f1f1f1}.content .under-title,.summary .under-title{display:flex;flex-wrap:wrap;justify-content:space-between;line-height:1.5;font-size:1rem}.content .under-title__info,.content .under-title__social-share,.summary .under-title__info,.summary .under-title__social-share{align-self:center}.content .under-title__social-share,.summary .under-title__social-share{display:flex;align-items:center}.content .under-title__social-share__button,.summary .under-title__social-share__button{margin:0 .5em;border-radius:50%;background-size:60%}.content .ad,.summary .ad{display:flex;margin:auto;align-content:center;width:min-content;border:1px solid #333}.content .ad__fallback,.summary .ad__fallback{display:flex;align-items:center}.content .ad__fallback p,.summary .ad__fallback p{margin:auto}@media(max-width:1200px){body{grid-gap:0}.main,.header,.footer{grid-column:1/span 12}.main,.footer{margin:.5em .75em 0 .5em}.header{margin:0}.header__menu{border:none;border-bottom:1px solid #333}h1{font-size:2.5rem}h2{font-size:2rem}h3{font-size:1.66rem}h4{font-size:1.25rem}}@media(max-width:600px){.under-title__social-share{width:100%;margin-top:1.5em;justify-content:space-between}}</style><title>Metablog #3 - Workflow con docker, makefile y Github actions</title><link href=https://asur.dev/metablogs/mejorando-workflow-docker-makefile-github-actions/ rel=canonical><link href=https://asur.dev/sitemap.xml rel=sitemap type=application/xml><link href=https://asur.dev/manifest.json rel=manifest><link href=https://asur.dev/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180></head><body><amp-install-serviceworker class=i-amphtml-layout-nodisplay data-iframe-src=https://asur.dev/install-sw.html hidden=hidden i-amphtml-layout=nodisplay layout=nodisplay src=https://asur.dev/sw.js></amp-install-serviceworker><amp-analytics class="i-amphtml-layout-fixed i-amphtml-layout-size-defined" data-credentials=include i-amphtml-layout=fixed style=width:1px;height:1px; type=gtag><script type=application/json>{"vars":{"gtag_id":"UA-128498798-1","config":{"UA-128498798-1":{"groups":"default"}}},"triggers":{"trackPageview":{"on":"visible","request":"pageview"}}}</script></amp-analytics><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/asur.dev","name":"Inicio"}},{"@type":"ListItem","position":2,"item":{"@id":"https:\/\/asur.dev\/metablogs\/","name":"Metablogs"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/asur.dev\/metablogs\/mejorando-workflow-docker-makefile-github-actions\/","name":"Mejorando workflow docker makefile github actions"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","image":"https:\/\/asur.dev\/images\/mejorando-workflow-docker-makefile-github-actions\/share-card.jpg","url":"https:\/\/asur.dev\/metablogs\/mejorando-workflow-docker-makefile-github-actions\/","headline":"Metablog #3 - Workflow con docker, makefile y Github actions","alternativeHeadline":"Metablog #3 - Workflow con docker, makefile y Github actions","dateCreated":"2019-11-04T10:12:32","datePublished":"2019-11-04T10:12:32","dateModified":"2019-11-04T10:12:32","inLanguage":"es","isFamilyFriendly":"true","copyrightYear":"2019","copyrightHolder":"Asur","accountablePerson":{"@type":"Person","name":"Asur","url":"\/"},"author":{"@type":"Person","name":"Asur","url":"https:\/\/asur.dev\/"},"creator":{"@type":"Person","name":"Asur","url":"https:\/\/asur.dev\/"},"publisher":{"@type":"Organization","name":"Asur Bernardo","url":"https:\/\/asur.dev","logo":{"@type":"ImageObject","url":"\/logo-amp-article.png","width":"600","height":"60"}},"mainEntityOfPage":"https:\/\/asur.dev\/metablogs\/mejorando-workflow-docker-makefile-github-actions\/","keywords":"[\"blog\",\"desarrollo\",\"gohugo\",\"despliegue continuo\",\"github actions\",\"makefile\",\"docker\",\"contenedores\"]","genre":"[\"Evolutivo\"]","articleSection":"Los metablogs | By Asur 🧐"}</script><header class=header><nav class=header__menu><a aria-label="Volver a la página de inicio" class=header__menu__logo data-rel=prefetch href=https://asur.dev/ target=_top><svg viewbox="0 0 39.687 39.688"><g transform="translate(0 -257.31)"><path d="M-4.7247 254.1h46.68v44.507h-46.68z" fill=#333 stroke-width=.26458></path><g aria-label=a/ fill=#fff stroke-width=.47195 transform="matrix(.95987 0 0 .99672 -.00047323 11.993)"><path d="m16.898 272.93v-7.3088c0-3.0104-1.9104-4.9208-5.7023-4.9208-1.4762.0-3.1262.26052-4.9787.95522l.63681 1.8381c1.5775-.54997 2.9525-.78154 3.9656-.78154 2.2723.0 3.6327.82496 3.6327 3.0248v1.2736h-2.2433c-4.6313.0-7.1496 1.7368-7.1496 4.8774.0 2.8367 1.867 4.7037 4.9208 4.7037 1.9683.0 3.6906-.72365 4.7761-2.142.43419 1.3605 1.4762 1.9683 2.7933 2.142l.59339-1.7078c-.8539-.26051-1.2447-.72365-1.2447-1.9538zm-6.2957 1.8091c-1.9828.0-2.938-.98416-2.938-2.8801.0-1.9538 1.2302-3.1985 4.5879-3.1985h2.1999v3.9222c-.91179 1.3605-2.3446 2.1565-3.8498 2.1565z" style=font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal></path><path d="m23.928 279.24 12.36-25.458-1.9394-.95521-12.389 25.545z" style=font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal></path></g></g></svg></a><ul class=header__menu__list><li><a href=https://github.com/asurbernardo rel="nofollow noopener noreferrer" target=_blank><span>GitHub</span></a></li><li><a href=https://www.linkedin.com/in/asur-bernardo/ rel="nofollow noopener noreferrer" target=_blank><span>LinkedIn</span></a></li><li><a href=https://twitter.com/asurbernardo rel="nofollow noopener noreferrer" target=_blank><span>Twitter</span></a></li><li><a data-rel=prefetch href=https://asur.dev/support/ target=_top><span>Apóyame</span></a></li></ul></nav></header><main class=main><article class=content><h1 id=nuevo-workflow-docker-makefile-y-cd-con-gh-actions>Nuevo workflow: docker, makefile y CD con GH actions</h1><section class=under-title><div class=under-title__info><time datetime=2019-11-04T10:12:32>4 de Noviembre 2019</time> por Asur<ul id=tags><li>Tags:</li> <li><a data-rel=prefetch href=https://asur.dev/tags/evolutivo/ target=_top>Evolutivo</a></li></ul></div><div class=under-title__social-share><amp-social-share aria-label="Compartir contenido" class="under-title__social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=system width=50></amp-social-share><amp-social-share aria-label="Compartir en Facebook" class="under-title__social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=facebook width=50></amp-social-share><amp-social-share aria-label="Compartir en Twitter" class="under-title__social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=twitter width=50></amp-social-share><amp-social-share aria-label="Compartir en Linkedin" class="under-title__social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=linkedin width=50></amp-social-share><amp-social-share aria-label="Compartir en Pinterest" class="under-title__social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=pinterest width=50></amp-social-share></div></section><p>Si antes comento en el primer post que he escrito en el blog que estoy contento con el workflow antes lo cambio, ahora cuento con un <strong>entorno dockerizado</strong>, un <strong>Makefile</strong> para mantener todos mis scripts ordenados y <strong>despliegue continuo</strong> con Github Actions, que se dice pronto.</p><p><b>Tabla de contenidos:</b></p><nav id=TableOfContents><ul><li><a href=#nuevo-workflow-docker-makefile-y-cd-con-gh-actions>Nuevo workflow: docker, makefile y CD con GH actions</a><ul><li><a href=#dockerizando>Dockerizando 🐳</a></li><li><a href=#el-makefile>El Makefile 🏗️</a></li><li><a href=#github-actions>Github Actions 🐱</a><ul><li><a href=#despliegue-continuo>Despliegue continuo</a></li></ul></li><li><a href=#siguientes-pasos>Siguientes pasos 👣</a></li></ul></li></ul></nav><p></p><h2 id=dockerizando>Dockerizando 🐳</h2><p>Para empezar, ¿qué repositorio moderno que se precie no está dockerizado?</p><blockquote><p><em>Ninguno!!</em></p></blockquote><p>Exacto! Y para evitar que la gente (yo) tenga que andar instalándose Golang y Hugo por cada ordenador en el que quiera desarrollar o escribir, pues mejor hacerlo con docker, no? <strong>NO</strong>?</p><p>Por supuesto esto no habría sido posible sin la inestimable ayuda de <a href=https://www.linkedin.com/in/javier-coscolla-cabrera-95948224/ target=_top>Javier</a>, un compañero de trabajo que me ha estado ayudando a afianzar conceptos sobre este maravilloso mundo de los contenedores y los sitemas informáticos!</p><p>Bien, vamos a ello… Este proceso tiene dos partes, un <code>Dockerfile</code> para construir la imagen:</p><div class=highlight><div class=chroma><table class=lntable><tbody><tr><td class=lntd><pre class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=k>FROM</span><span class=s> alpine:edge</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> apk update <span class=se>\
</span><span class=se></span>    <span class=o>&amp;&amp;</span> apk add git hugo --no-cache <span class=se>\
</span><span class=se></span>    <span class=o>&amp;&amp;</span> rm -vrf /var/cache/apk/*<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> git clone https://github.com/asurbernardo/blog.git<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /blog</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> git submodule foreach pull origin master<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>EXPOSE</span><span class=s> 1313</span></code></pre></td></tr></tbody></table></div></div><p>y un <code>docker-compose.yml</code> para parametrizar y levantar el entorno:</p><div class=highlight><div class=chroma><table class=lntable><tbody><tr><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml>version<span class=p>:</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=w>
</span><span class=w></span>services<span class=p>:</span><span class=w>
</span><span class=w>  </span>web<span class=p>:</span><span class=w>
</span><span class=w>    </span>build<span class=p>:</span><span class=w> </span>.<span class=w>
</span><span class=w>    </span>ports<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span><span class=s2>&#34;1313:1313&#34;</span><span class=w>
</span><span class=w>    </span>volumes<span class=p>:</span><span class=w>
</span><span class=w>      </span>-<span class=w> </span>.<span class=p>:</span>/blog<span class=w>
</span><span class=w>    </span>command<span class=p>:</span><span class=w> </span>hugo<span class=w> </span>server<span class=w> </span>--verbose<span class=w> </span>--watch<span class=w> </span>--buildFuture<span class=w> </span>--buildDrafts<span class=w> </span>-D<span class=w> </span>--bind<span class=w> </span><span class=m>0.0.0.0</span></code></pre></td></tr></tbody></table></div></div><p>La imagen que se crea con el <code>Dockerfile</code> ocupa aproximadamente ~80Mb, utiliza la base <code>alpine</code> que es una imagen basada en <a href=https://alpinelinux.org/ target=_top>Alpine Linux</a> que solo ocupa 5Mb! No hace más que instalar Hugo y descargar el repositorio, creando así una build agnóstica del entorno.</p><p>En el <code>docker-compose</code> ya es donde configuramos todo lo necesario para nuestro entorno actual, en este caso el local. Vamos a ver línea por línea:</p><ul><li><p><strong>Línea 1</strong>: Declarar la versión del <em>compose file</em>, ojo aquí que depende del <em>Docker engine</em> que uses hay que <a href=https://docs.docker.com/compose/compose-file/ target=_top>usar una versión u otra</a>.</p></li><li><p><strong>Línea 2-3</strong>: Declarar los servicios, en este caso solo hay uno, pero por ejemplo, en el caso de tener una aplicación estilo LAMP, pondrías tu Apache, tu MySQL y tu PHP-fpm.</p></li><li><p><strong>Línea 4</strong>: Que imagen utilizar para el servicio, se puede elegir una subida en un repositorio público como <a href=https://hub.docker.com/ target=_top>Docker Hub</a> o, como en este caso, usar un <code>Dockerfile</code> local utilizando un path relativo.</p></li><li><p><strong>Línea 5-6</strong>: El mapeo de puertos. Aquí siempre me lío y lo tengo que consultar, el orden es <code>HOST:CONTAINER</code> Asur, <code>HOST:CONTAINER</code>, <code>HOST:CONTAINER</code>, <code>HOST:CONTAINER</code>!</p></li><li><p><strong>Línea 7-8</strong>: El mapeo de volúmenes. Lo mismo que los puertos pero con directorios… Ah sí, <code>HOST:CONTAINER</code>!!</p></li><li><p><strong>Línea 9</strong>: El comando inicial al ejecutar un <code>docker-compose up</code> para ya tener el servidor levantado y funcionando.</p></li></ul><p>Es un ejemplo muy simple pero tiene los casos de uso más comunes, seguiré investigando funcionalidades más avanzadas y os iré contando si cambio algo.</p><h2 id=el-makefile>El Makefile 🏗️</h2><p>Esto ha sido la sorpresa del mes, como me comenta Javier, el Makefile es más viejo que muchos de nosotros y es verdad, lo he buscado en la Wikipedia, es de Abril de 1976!</p><p>Todo esto porque ha resurgido últimamente la moda de utilizar uno de estos ficheros para organizar los comandos de tu proyecto, para que los puedas ejecutar todos de manera secuencial o cada uno individualmente y he de admitir que me gusta mucho, igual es algo <em>hipster</em>, si, pero es cómodo al fin y al cabo.</p><p>Tras una breve sesión de investigación de la sintaxis lo único que tuve que hacer fué migrar mi antiguo <code>deploy.sh</code> y reorganizarlo en comandos más atómicos:</p><div class=highlight><div class=chroma><table class=lntable><tbody><tr><td class=lntd><pre class=chroma><code class=language-makefile data-lang=makefile><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-makefile data-lang=makefile><span class=c># Declarar que scripts se van a invocar cuando se llame a make asecas
</span><span class=c></span><span class=nf>all</span><span class=o>:</span> <span class=n>update_theme</span> <span class=n>clone_site</span> <span class=n>compile</span> <span class=n>deploy</span>
<span class=nf>.PHONY</span><span class=o>:</span> <span class=n>all</span>

<span class=c># Variables!
</span><span class=c></span><span class=nv>NOW</span> <span class=o>=</span> <span class=k>$(</span>shell date<span class=k>)</span>
<span class=nv>GITHUB_PAGES_REPO</span> <span class=o>=</span> git@github.com:asurbernardo/asurbernardo.github.io.git

<span class=c># Distintos scripts de la pipeline de despliegue
</span><span class=c></span><span class=nf>update_theme</span><span class=o>:</span>
    @printf <span class=s2>&#34;\033[0;32mUpdating theme submodule...\033[0m\n&#34;</span>
    git submodule foreach git pull origin master

<span class=nf>clone_site</span><span class=o>:</span>
    @printf <span class=s2>&#34;\033[0;32mCloning site from remote...\033[0m\n&#34;</span>
    rm -rf public
    git clone <span class=k>$(</span>GITHUB_PAGES_REPO<span class=k>)</span> public

<span class=nf>compile</span><span class=o>:</span>
    @printf <span class=s2>&#34;\033[0;32mCompiling content...\033[0m\n&#34;</span>
    hugo -t amperage --minify

<span class=nf>deploy</span><span class=o>:</span>
    @printf <span class=s2>&#34;\033[0;32mDeploying content to Github...\033[0m\n&#34;</span>
    <span class=nb>cd</span> public <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>        git add --all <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>        git commit -m <span class=s2>&#34;Rebuilding site - </span><span class=k>$(</span>NOW<span class=k>)</span><span class=s2>&#34;</span> <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>        git push origin master
</code></pre></td></tr></tbody></table></div></div><p>Como se puede ver en este snippet, hay 4 partes bien diferenciadas, aunque todas juntas formen la pipeline de despliegue y las pueda invocar con un <code>make</code>, también puedo hacer <code>make update_theme</code> si lo necesitase y ejecutaría solo ese script.</p><p>Al ejecutarlo todo junto se ve algo así:</p><amp-anim alt="Output de consola del comando make" class="i-amphtml-layout-responsive i-amphtml-layout-size-defined" height=1112 i-amphtml-layout=responsive layout=responsive src=https://asur-dev.cdn.ampproject.org/i/s/asur.dev/images/mejorando-workflow-docker-makefile-github-actions/make-command.gif width=1367><i-amphtml-sizer style=display:block;padding-top:81.3460%;></i-amphtml-sizer></amp-anim><p><strong>OJO</strong>: He descubierto por las malas que <strong>cada línea de un Makefile se ejecuta en un entorno independiente</strong>, siempre partiendo de la raiz desde donde se ha ejecutado el <code>make</code>, así que olvídate de cambiarte de directorio y hacer algo en una línea nueva por que no te va a funcionar (la que he armado en mi historial de git probando esto fué muy gorda).</p><h2 id=github-actions>Github Actions 🐱</h2><p>Microsoft parece que le está dando bastante amor a Github en forma de $$$ porque ya no solo tenemos repositorios privados gratuitos, ahora también tenemos una pipeline de CI/CD en Beta, es casi como si estuviesen copiando a GitLab!!</p><p>La Beta es abierta y mientras tengas un repositorio puedes activarla, las inscripciones se hacen en la <a href=https://github.com/features/actions target=_top>página oficial de actions</a>. Una vez apuntado se añadirá una pestaña de <em>Actions</em> para tu repositorio donde puedes acceder a un marketplace de snippets, pero sinceramente yo prefiero escribir la pipeline por mi cuenta a instalar los workflows como si fuesen apps, así que solo lo utilizo como un buscador.</p><p>Los límites de uso son <strong>MUY</strong> generosos, de la <a href=https://help.github.com/es/github/automating-your-workflow-with-github-actions/about-github-actions#usage-limits target=_top>documentación oficial de GH actions</a>:</p><ul><li>Puedes ejecutar hasta 20 flujos de trabajo simultáneamente por repositorio.</li><li>Puedes ejecutar hasta 1000 solicitudes API en una hora en todas las acciones dentro de un repositorio.</li><li>Cada trabajo en un flujo de trabajo puede ejecutarse por hasta 6 horas de tiempo de ejecución.</li><li>Puedes ejecutar hasta 20 trabajos simultáneamente por repositorio en todos los flujos de trabajo.</li></ul><p>Por supuesto, todo esto está hosteado en <strong>Azure</strong>, eso le permite a Github dar estos usos tan amplios. En concreto cada entorno virtual está hosteado en una instancia de tipo <code>Standard_DS2_v2</code>, que tienen <strong>2 core CPUs, 7 GB of RAM memory, 14 GB of SSD disk space</strong>, de nuevo… <em>Holy $hit!</em></p><p>Los ficheros de configuración son formato <code>yml</code> y tienen una sintaxis parecida a otros proveedores de funcionalidades pareceidas como Travis o CircleCI. Siempre viene bien tener las cosas unificadas (aunque Travis y compañia para repositorios abiertos son gratis también) y además es algo nuevo y había que probarlo.</p><h3 id=despliegue-continuo>Despliegue continuo</h3><p>Desde mi punto de vista, <strong>el mejor workflow es no tener workflow</strong> y como esto es un site estático y no necesito ningún tipo de integración, os presento a mi mejor amigo desde hace una semana: el <em>Continuous Deployment</em>.</p><p>Para que GH te detecte el fichero hay que crealo en la ruta <code>.github/workflows/main.yml</code> y mi resultado final se ve así:</p><div class=highlight><div class=chroma><table class=lntable><tbody><tr><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>name<span class=p>:</span><span class=w> </span>Deploy<span class=w> </span>blog<span class=w>
</span><span class=w></span>on<span class=p>:</span><span class=w>
</span><span class=w>  </span>push<span class=p>:</span><span class=w>
</span><span class=w>    </span>branches<span class=p>:</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>master<span class=w>
</span><span class=w>
</span><span class=w></span>jobs<span class=p>:</span><span class=w>
</span><span class=w>  </span>build-deploy<span class=p>:</span><span class=w>
</span><span class=w>    </span>runs-on<span class=p>:</span><span class=w> </span>ubuntu-latest<span class=w>
</span><span class=w>    </span>steps<span class=p>:</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Pull<span class=w> </span>source<span class=w>
</span><span class=w>      </span>uses<span class=p>:</span><span class=w> </span>actions/checkout@master<span class=w>
</span><span class=w>      </span>with<span class=p>:</span><span class=w>
</span><span class=w>        </span>submodules<span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Update<span class=w> </span>submodules<span class=w> </span>to<span class=w> </span>latests<span class=w> </span>master<span class=w>
</span><span class=w>      </span>run<span class=p>:</span><span class=w> </span>git<span class=w> </span>submodule<span class=w> </span>foreach<span class=w> </span>git<span class=w> </span>pull<span class=w> </span>origin<span class=w> </span>master<span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Setup<span class=w> </span>Hugo<span class=w>
</span><span class=w>      </span>uses<span class=p>:</span><span class=w> </span>peaceiris/actions-hugo@v2<span class=m>.2.2</span><span class=w>
</span><span class=w>      </span>with<span class=p>:</span><span class=w>
</span><span class=w>        </span>hugo-version<span class=p>:</span><span class=w> </span><span class=s1>&#39;0.58.3&#39;</span><span class=w>
</span><span class=w>        </span>extended<span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Build<span class=w>
</span><span class=w>      </span>run<span class=p>:</span><span class=w> </span>hugo<span class=w> </span>-t<span class=w> </span>amperage<span class=w> </span>--gc<span class=w> </span>--minify<span class=w>
</span><span class=w>
</span><span class=w>    </span>-<span class=w> </span>name<span class=p>:</span><span class=w> </span>Deploy<span class=w> </span>script<span class=w>
</span><span class=w>      </span>uses<span class=p>:</span><span class=w> </span>peaceiris/actions-gh-pages@v2<span class=m>.5.0</span><span class=w>
</span><span class=w>      </span>env<span class=p>:</span><span class=w>
</span><span class=w>        </span>ACTIONS_DEPLOY_KEY<span class=p>:</span><span class=w> </span>${{<span class=w> </span>secrets.ACTIONS_DEPLOY_KEY<span class=w> </span>}}<span class=w>
</span><span class=w>        </span>EXTERNAL_REPOSITORY<span class=p>:</span><span class=w> </span>asurbernardo/asurbernardo.github.io<span class=w>
</span><span class=w>        </span>PUBLISH_BRANCH<span class=p>:</span><span class=w> </span>master<span class=w>
</span><span class=w>        </span>PUBLISH_DIR<span class=p>:</span><span class=w> </span>./public</code></pre></td></tr></tbody></table></div></div><p>Para empezar tenemos que declarar el nombre del workflow (línea 1) y en que casos se ejecuta, para mi situación, lo mejor es con cada push a master (línea 2-5).</p><p>Después hay que crear la pipeline, primero el SO en el que se ejecutará, en mi caso Ubuntu (línea x) y después cada uno de los pasos:</p><ul><li><strong>Pull source:</strong> Este es un paso bastante estandar entre todas las GH actions que he investigado, su función es hacer accesible el código del repositorio a la pipeline.</li><li><strong>Update submodules to latests master:</strong> Este es un <em>step</em> que ejecuta un comando que se descarga la última versión del tema Amperage.</li><li><strong>Setup Hugo:</strong> Primer ejemplo de como podemos usar una action externa, las configuraciones suelen estar explicadas en el <em>README.md</em> del repositorio con el mismo nombre que el contenido del campo <code>uses</code>.</li><li><strong>Build:</strong> Otro comando, pero en este caso utiliza el entorno configurado en el paso anterior, es decir, en cada paso puedes configurar el entorno.</li><li><strong>Deploy script:</strong> De nuevo, una action externa con algo más de configuración, lo único destacable es que los secrets se pueden añadir en la configuración del repositorio y son accesibles desde la pipeline, muy útiles si necesitas una clave de despliegue como es mi caso.</li></ul><p>Si quieres ver como se han configurado los pasos 3 y 5 puedes visitar el <a href=https://github.com/peaceiris target=_top>perfil de <em>peaceiris</em></a>, parece que ha pasado sus horas pegándose con GH actions y es una máquina (<a href=https://github.com/peaceiris/actions-gh-pages/issues/45 target=_top>con soporte incluido!</a>).</p><p>La verdad es que una vez lo tienes funcionando, aunque la interfaz de Github a veces tiene algún bug es algo muy satisfactorio de ver:</p><amp-video alt="Output de consola del comando make" class="i-amphtml-layout-responsive i-amphtml-layout-size-defined" controls height=576 i-amphtml-layout=responsive layout=responsive src=https://asur.dev/videos/gh-actions-workflow.m4v width=1280><i-amphtml-sizer style=display:block;padding-top:45.0000%;></i-amphtml-sizer></amp-video><p>De media suele tardar unos 30 segundos desde que hago el push en estar ya desplegado, no está nada mal, lo único que espero es no levantarme un día y ver que me van a quitar esta funcionalidad a no ser que empiece a pagar.</p><h2 id=siguientes-pasos>Siguientes pasos 👣</h2><p>Para la próxima tanda creo que voy a añadir botones de compartir, la capacidad de elegir solo los scripts de AMP necesarios para cada post en vez de declararlos de manera global, así evitaré descargas innecesarias, también una redistribución del contenido a una sola columna sin sidebar para mejorar la experiencia de lectura y si me da tiempo incluiré los datos estructurados de artículo en los posts, así que como siempre, <em>stay tuned!</em> 😎</p><h2 class=related-content__title>Lecturas relacionadas 📖</h2><p class=related-content__item><a data-rel=prefetch href=https://asur.dev/metablogs/taxonomia-de-tags-highlight-codigo-analitica/ target=_top>Metablog #2 - Tags, highlighting de código y analítica</a></p><p class=related-content__item><a data-rel=prefetch href=https://asur.dev/metablogs/la-primera-iteracion-amp-estilos-y-miscelanea/ target=_top>Metablog #1 - AMP, estilos y otras miscelaneas</a></p><p class=related-content__item><a data-rel=prefetch href=https://asur.dev/metablogs/el-primer-post-en-mi-nuevo-blog/ target=_top>Metablog #0 - El primer post en mi nuevo blog!</a></p></article><amp-iframe class="i-amphtml-layout-responsive i-amphtml-layout-size-defined" height=140 i-amphtml-layout=responsive layout=responsive resizable sandbox="allow-scripts allow-same-origin allow-modals allow-popups allow-forms" src=https://disqus.asur.dev#/metablogs/mejorando-workflow-docker-makefile-github-actions/ width=600><i-amphtml-sizer style=display:block;padding-top:23.3333%;></i-amphtml-sizer><div aria-label="Load more comments" overflow role=button style="display:block;font-size:12px;font-weight:500;font-family:Helvetica Neue,arial,sans-serif;text-align:center;line-height:1.1;padding:12px 16px;border-radius:4px;background:rgba(29,47,58,.6);color:#fff" tabindex=0>Load more</div></amp-iframe></main><footer class=footer><div class=footer__copyright>© asur.dev 2019</div><div class=footer__languages><b>Español</b>
<a data-rel=prefetch href=https://asur.dev/en target=_top>English</a></div></footer></body></html>
