<!doctype html><html i-amphtml-layout i-amphtml-no-boilerplate lang=es transformed="google;v=2" ⚡><head><meta charset=utf-8><style amp-runtime i-amphtml-version=latest></style><meta content="width=device-width,minimum-scale=1,initial-scale=1" name=viewport><meta content="La idea de AMP es ofrecer una web más rápida y segura, ¿pero sabías que aún se puede optimizar más con Server Side Rendering?" name=description><meta content="Metablog #7 - SSR de AMP en build time con GH actions" property=og:title><meta content=https://asur.dev/metablogs/ssr-de-amp-en-build-time-con-github-actions/ property=og:url><meta content="La idea de AMP es ofrecer una web más rápida y segura, ¿pero sabías que aún se puede optimizar más con Server Side Rendering?" property=og:description><meta content=https://asur.dev/images/amp-ssr-en-build-time-con-github-actions/share-card.jpg property=og:image><meta content=article property=og:type><meta content property=og:site_name><meta content=summary_large_image name=twitter:card><meta content="Metablog #7 - SSR de AMP en build time con GH actions" name=twitter:title><meta content=https://asur.dev/metablogs/ssr-de-amp-en-build-time-con-github-actions/ name=twitter:url><meta content="La idea de AMP es ofrecer una web más rápida y segura, ¿pero sabías que aún se puede optimizar más con Server Side Rendering?" name=twitter:description><meta content=https://asur.dev/images/amp-ssr-en-build-time-con-github-actions/share-card.jpg name=twitter:image><meta content=@asurbernardo name=twitter:site><meta content=#333 name=theme-color><script async src=https://cdn.ampproject.org/v0.js></script><script async custom-element=amp-analytics src=https://cdn.ampproject.org/v0/amp-analytics-0.1.js></script><script async custom-element=amp-iframe src=https://cdn.ampproject.org/v0/amp-iframe-0.1.js></script><script async custom-element=amp-install-serviceworker src=https://cdn.ampproject.org/v0/amp-install-serviceworker-0.1.js></script><script async custom-element=amp-social-share src=https://cdn.ampproject.org/v0/amp-social-share-0.1.js></script><link href=https://asur-dev.cdn.ampproject.org/i/s/asur.dev/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=https://asur-dev.cdn.ampproject.org/i/s/asur.dev/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href rel="dns-prefetch preconnect"><link href=https://asur-dev.cdn.ampproject.org rel="dns-prefetch preconnect"><style amp-custom>*,*::before,*::after{box-sizing:border-box}ul[class],ol[class]{padding:0}body,h1,h2,h3,h4,p,ul[class],ol[class],li,figure,figcaption,blockquote,dl,dd{margin:0}body{min-height:100vh;scroll-behavior:smooth;text-rendering:optimizeSpeed}ul[class],ol[class]{list-style:none}a:not([class]){text-decoration-skip-ink:auto}img{max-width:100%;display:block}input,button,textarea,select{font:inherit}.chroma{background-color:#fff}.chroma .err{color:#a61717;background-color:#e3d2d2}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .k{color:#000;font-weight:700}.chroma .kc{color:#000;font-weight:700}.chroma .kd{color:#000;font-weight:700}.chroma .kn{color:#000;font-weight:700}.chroma .kp{color:#000;font-weight:700}.chroma .kr{color:#000;font-weight:700}.chroma .kt{color:#458;font-weight:700}.chroma .na{color:teal}.chroma .nb{color:#0086b3}.chroma .bp{color:#999}.chroma .nc{color:#458;font-weight:700}.chroma .no{color:teal}.chroma .nd{color:#3c5d5d;font-weight:700}.chroma .ni{color:purple}.chroma .ne{color:#900;font-weight:700}.chroma .nf{color:#900;font-weight:700}.chroma .nl{color:#900;font-weight:700}.chroma .nn{color:#555}.chroma .nt{color:navy}.chroma .nv{color:teal}.chroma .vc{color:teal}.chroma .vg{color:teal}.chroma .vi{color:teal}.chroma .s{color:#d14}.chroma .sa{color:#d14}.chroma .sb{color:#d14}.chroma .sc{color:#d14}.chroma .dl{color:#d14}.chroma .sd{color:#d14}.chroma .s2{color:#d14}.chroma .se{color:#d14}.chroma .sh{color:#d14}.chroma .si{color:#d14}.chroma .sx{color:#d14}.chroma .sr{color:#009926}.chroma .s1{color:#d14}.chroma .ss{color:#990073}.chroma .m{color:#099}.chroma .mb{color:#099}.chroma .mf{color:#099}.chroma .mh{color:#099}.chroma .mi{color:#099}.chroma .il{color:#099}.chroma .mo{color:#099}.chroma .o{color:#000;font-weight:700}.chroma .ow{color:#000;font-weight:700}.chroma .c{color:#998;font-style:italic}.chroma .ch{color:#998;font-style:italic}.chroma .cm{color:#998;font-style:italic}.chroma .c1{color:#998;font-style:italic}.chroma .cs{color:#999;font-weight:700;font-style:italic}.chroma .cp{color:#999;font-weight:700;font-style:italic}.chroma .cpf{color:#999;font-weight:700;font-style:italic}.chroma .gd{color:#000;background-color:#fdd}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#a00}.chroma .gh{color:#999}.chroma .gi{color:#000;background-color:#dfd}.chroma .go{color:#888}.chroma .gp{color:#555}.chroma .gs{font-weight:700}.chroma .gu{color:#aaa}.chroma .gt{color:#a00}.chroma .gl{text-decoration:underline}.chroma .w{color:#bbb}body{display:grid;grid-template-columns:repeat(12,1fr);grid-gap:1em 1em;font-size:1.2em;font-family:Courier New;line-height:1.6;color:#000}.header,.main,.footer{grid-column:4/span 6}.header{margin-top:1em}.header__menu{margin:0;padding:0;display:flex;overflow:auto;justify-content:flex-start;border:1px solid #333}.header__menu a{font-size:1.2em;white-space:nowrap;border-bottom:none}.header__menu a:hover{color:#d14}.header__menu__logo{line-height:0}.header__menu__logo svg{width:75px;height:75px;min-width:75px;min-height:75px}.header__menu__list{display:flex;flex-grow:1;flex-wrap:nowrap;align-items:center;justify-content:space-around}.header__menu__list li{padding:0 1em;display:inline}.main{min-width:0;min-height:80vh}.main .pagination{margin:3em auto 2em;display:flex;justify-content:space-between}.footer{display:flex;justify-content:space-between;flex-wrap:wrap}h1{font-size:3.5rem}h2{font-size:2.5rem}h3{font-size:2rem}h4{font-size:1.5rem}a{color:inherit;text-decoration:none;transition:background .3s;border-bottom:2px dashed #37474f}a:hover{border-color:#d14}.button{padding:.5em .75em;font-size:1.2em;text-align:center;border:1px solid #000;box-shadow:7px 7px 0 0 #333}.button:hover{color:#d14;border:1px solid #000;transform:translate(4px,4px);box-shadow:3px 3px 0 0 #333}li{margin-top:.25em}pre,code{font-family:lucida console,Monaco,monospace;font-size:12pt;background-color:#f1f1f1}blockquote{margin:inherit auto;margin-left:1em;padding:1em;border-left:5px solid #999}blockquote:before{display:none}blockquote:not(:first-of-type){margin-top:.5em}blockquote p{color:#555;font-size:1.25em;font-family:times new roman,serif}.figure{width:100%;max-width:100%}.figure--with-caption{display:flex;border-top:6px solid #333}.figure__image--with-caption{min-width:70%}.figure__caption{background-color:#333;color:#fff;font-weight:700;padding:.5em 1em;height:min-content;word-wrap:break-word}.post-it{width:100%;padding:1.5em}.post-it--tip{background-color:#fffacd}.post-it--info{background-color:azure}.post-it--danger{background-color:#ffcccb}.post-it--success{background-color:#d0f0c0}.post-it__title{font-weight:700;font-size:1.5em}.product{width:100%;display:flex;justify-content:space-between;padding:1.5em;border:1px solid #333}.product__image{margin:auto;width:100%;min-width:250px;max-width:400px}.product__content{margin-left:2em;align-self:center;display:flex;flex-direction:column}.product__title{font-weight:700;font-size:1.5rem}.product__description{margin-top:1em}.product__cta{margin-top:1em}.social-share{display:flex;align-self:center;align-items:center}.social-share__button{margin:0 .5em;border-radius:50%;background-size:60%}#tags{margin:0;padding:0}#tags li{display:inline}.content{width:100%}.content>*{margin-top:1.5em}.content>h1{margin-top:.5em}.content pre{overflow:auto;padding:.5em}.content code{padding:.1em}.content table{display:block;overflow-x:auto;border-collapse:collapse}.content table td,.content table th{border:1px solid #ddd}.content table td{padding:.5em 1em}.content table th{padding:1em 2em;background-color:#333;color:#fff}.content table tr:nth-child(even){background-color:#f1f1f1}.content table tr:hover{background-color:#ddd}.content .highlight .chroma{background-color:#f1f1f1}.content .under-title{display:flex;flex-wrap:wrap;justify-content:space-between;font-size:1rem}.content .under-title__info,.content .under-title__social-share{align-self:center}.content .ad{display:flex;margin:1rem auto;align-content:center;width:min-content;height:min-content;min-width:320px;min-height:320px;border:1px solid #333}.content .ad__fallback{display:flex;align-items:center}.content .ad__fallback p{margin:auto}.content .author{display:flex;flex-direction:column;align-items:center;background-color:#f1f1f1;padding:1.5rem}.content .author>*:not(:first-child){margin-top:1rem}.content .author__name{font-weight:700;font-size:1.5em}.content .author__image{border-radius:100px}.content .author__bio{text-align:center}.content .author__cta{font-size:1.25em}.summary:not(:first-of-type) h2{margin-top:2.5em}.summary>*{margin-top:1.25em}.summary__title{text-align:center}.summary .button{display:block;margin:inherit 1em}@media(max-width:1200px){body{grid-gap:0}.main,.header,.footer{grid-column:1/span 12}.main,.footer{margin:1em .75em 0 .5em}.header{margin:0}.header__menu{border:none;border-bottom:1px solid #333}h1{font-size:2.5rem}h2{font-size:2rem}h3{font-size:1.66rem}h4{font-size:1.25rem}.post-it{margin-left:0;margin-right:0}}@media(max-width:600px){.under-title__social-share{width:100%;margin-top:1.5em;justify-content:space-between}.figure{flex-direction:column-reverse}.figure--with-caption{border-top:none}.figure__caption{position:relative;max-width:100%}.product{flex-wrap:wrap}.product__content{margin-left:unset;text-align:center}.product__title{margin-top:1em}}</style><title>Metablog #7 - SSR de AMP en build time con GH actions</title><link href=https://asur.dev/metablogs/ssr-de-amp-en-build-time-con-github-actions/ rel=canonical><link href=https://asur.dev/sitemap.xml rel=sitemap type=application/xml><link href=https://asur.dev/manifest.json rel=manifest><link href=https://asur.dev/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180></head><body><amp-install-serviceworker class=i-amphtml-layout-nodisplay data-iframe-src=https://asur.dev/install-sw.html hidden=hidden i-amphtml-layout=nodisplay layout=nodisplay src=https://asur.dev/sw.js></amp-install-serviceworker><amp-analytics class="i-amphtml-layout-fixed i-amphtml-layout-size-defined" data-credentials=include i-amphtml-layout=fixed style=width:1px;height:1px; type=gtag><script type=application/json>{"vars":{"gtag_id":"UA-128498798-1","config":{"UA-128498798-1":{"groups":"default"}}},"triggers":{"trackPageview":{"on":"visible","request":"pageview"}}}</script></amp-analytics><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/asur.dev","name":"Inicio"}},{"@type":"ListItem","position":2,"item":{"@id":"https:\/\/asur.dev\/metablogs\/","name":"Metablogs"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/asur.dev\/metablogs\/ssr-de-amp-en-build-time-con-github-actions\/","name":"Ssr de amp en build time con github actions"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","image":"https:\/\/asur.dev\/images\/amp-ssr-en-build-time-con-github-actions\/share-card.jpg","url":"https:\/\/asur.dev\/metablogs\/ssr-de-amp-en-build-time-con-github-actions\/","headline":"Metablog #7 - SSR de AMP en build time con GH actions","alternativeHeadline":"Metablog #7 - SSR de AMP en build time con GH actions","dateCreated":"2019-12-05T09:52:05","datePublished":"2019-12-05T09:52:05","dateModified":"2019-12-05T09:52:05","inLanguage":"es","isFamilyFriendly":"true","copyrightYear":"2019","copyrightHolder":"Asur Bernardo","accountablePerson":{"@type":"Person","name":"Asur Bernardo","url":"\/"},"author":{"@type":"Person","name":"Asur Bernardo","url":"https:\/\/asur.dev\/","image":"https:\/\/asur.dev\/images\/me.jpg","description":"Back end developer sin ningún tipo de gusto estético. Me encanta el cacharreo y la tecnología. Siempre intento aprender cosas nuevas."},"creator":{"@type":"Person","name":"Asur Bernardo","url":"https:\/\/asur.dev\/","image":"https:\/\/asur.dev\/images\/me.jpg","description":"Back end developer sin ningún tipo de gusto estético. Me encanta el cacharreo y la tecnología. Siempre intento aprender cosas nuevas."},"publisher":{"@type":"Organization","name":"Asur Bernardo","url":"https:\/\/asur.dev","logo":{"@type":"ImageObject","url":"\/logo-amp-article.png","width":"600","height":"60"}},"mainEntityOfPage":"https:\/\/asur.dev\/metablogs\/ssr-de-amp-en-build-time-con-github-actions\/","keywords":"[\"blog\",\"desarrollo\",\"gohugo\",\"github actions\",\"ssr\",\"amp\",\"optimizacion\"]","genre":"[\"Evolutivo\"]","articleSection":"Los metablogs | By Asur 🧐"}</script><header class=header><nav class=header__menu><a aria-label="Volver a la página de inicio" class=header__menu__logo data-rel=prefetch href=https://asur.dev target=_top><svg viewbox="0 0 39.687 39.688"><g transform="translate(0 -257.31)"><rect fill=#333 height=44.507 stroke-width=.26458 width=46.68 x=-4.7247 y=254.1></rect><g aria-label=a/ fill=#fff stroke-width=.47195 transform="matrix(.95987 0 0 .99672 -.00047323 11.993)"><path d="m16.898 272.93v-7.3088c0-3.0104-1.9104-4.9208-5.7023-4.9208-1.4762.0-3.1262.26052-4.9787.95522l.63681 1.8381c1.5775-.54997 2.9525-.78154 3.9656-.78154 2.2723.0 3.6327.82496 3.6327 3.0248v1.2736h-2.2433c-4.6313.0-7.1496 1.7368-7.1496 4.8774.0 2.8367 1.867 4.7037 4.9208 4.7037 1.9683.0 3.6906-.72365 4.7761-2.142.43419 1.3605 1.4762 1.9683 2.7933 2.142l.59339-1.7078c-.8539-.26051-1.2447-.72365-1.2447-1.9538zm-6.2957 1.8091c-1.9828.0-2.938-.98416-2.938-2.8801.0-1.9538 1.2302-3.1985 4.5879-3.1985h2.1999v3.9222c-.91179 1.3605-2.3446 2.1565-3.8498 2.1565z" style=font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal></path><path d="m23.928 279.24 12.36-25.458-1.9394-.95521-12.389 25.545z" style=font-feature-settings:normal;font-variant-caps:normal;font-variant-ligatures:normal;font-variant-numeric:normal></path></g></g></svg></a><ul class=header__menu__list><li><a href=https://github.com/asurbernardo rel="nofollow noopener noreferrer" target=_blank><span>GitHub</span></a></li><li><a href=https://twitter.com/asurbernardo rel="nofollow noopener noreferrer" target=_blank><span>Twitter</span></a></li><li><a data-rel=prefetch href=https://asur.dev/uses target=_top><span>/Uses</span></a></li><li><a data-rel=prefetch href=https://asur.dev/support target=_top><span>Apóyame</span></a></li></ul></nav></header><main class=main><article class=content><h1 id=ssr-de-amp-en-build-time-con-gh-actions>SSR de AMP en build time con GH actions</h1><section class=under-title><div class=under-title__info><time datetime=2019-12-05T09:52:05>5 de Diciembre 2019</time>
por Asur Bernardo<ul id=tags><li>Tags:</li> <li><a data-rel=prefetch href=https://asur.dev/tags/evolutivo/ target=_top>Evolutivo</a></li></ul></div><div class="under-title__social-share social-share"><amp-social-share aria-label="Compartir contenido" class="social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=system width=50></amp-social-share><amp-social-share aria-label="Compartir en Facebook" class="social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=facebook width=50></amp-social-share><amp-social-share aria-label="Compartir en Twitter" class="social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=twitter width=50></amp-social-share><amp-social-share aria-label="Compartir en Linkedin" class="social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=linkedin width=50></amp-social-share><amp-social-share aria-label="Compartir en Pinterest" class="social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=pinterest width=50></amp-social-share></div></section><p>Toda la idea sobre el proyecto de <strong>AMP</strong> es ofrecer una web más rápida y segura, ¿pero sabías que se puede optimizar aún más con <strong>Server Side Rendering</strong>? Pues si, y adivina qué, lo he implementado en mi propia <strong>GitHub Action</strong>!</p><p><b>Tabla de contenidos:</b></p><nav id=TableOfContents><ul><li><a href=#ssr-de-amp-en-build-time-con-gh-actions>SSR de AMP en build time con GH actions</a><ul><li><a href=#para-qué-sirve-el-ssr-en-amp>¿Para qué sirve el SSR en AMP? 🤔</a></li><li><a href=#creación-y-despliegue-en-github-actions>Creación y despliegue en GitHub Actions 😺</a><ul><li><a href=#script-de-bash>Script de bash</a></li><li><a href=#dockerización>Dockerización</a></li><li><a href=#publicación-en-el-marketplace>Publicación en el marketplace</a></li></ul></li><li><a href=#próximo-destino>Próximo destino 🛣️</a></li></ul></li></ul></nav><p></p><h2 id=para-qué-sirve-el-ssr-en-amp>¿Para qué sirve el SSR en AMP? 🤔</h2><p>Esa es la pregunta del millón, AMP se supone que ya proporciona un rendimiento excelente, pero nada es perfecto y hay algunos puntos de mejora.</p><p>El cambio más destacable se ve en el tiempo de FCP (<em>First Contentful Paint</em>), que <strong>puede reducirse hasta un 50%</strong>!!</p><p>Esta mejora se debe a que el script de preprocesado elimina el código de <code>&lt;style amp-boilerplate&gt;</code>.</p><p>El kit de la cuestión es que ese estilo de <strong>AMP boilerplate oculta el contenido mientras se calcula la distribución del layout</strong>, si eliminamos la necesidad de ese cálculo haciéndolo de antemano nuestra página se muestra directamente, sin esperas.</p><blockquote><p>¿Y por qué no aplicamos estas mejoras a mano?</p></blockquote><p>En efecto, estas mejoras se podrían picar a mano, pero no es viable por la mera cantidad de propiedades y variaciones. Un ejemplo de HTML antes y después:</p><figure class=figure><amp-img alt="Comparación de página AMP normal contra procesada" class="figure__image i-amphtml-layout-responsive i-amphtml-layout-size-defined" height=480 i-amphtml-layout=responsive layout=responsive src=https://asur-dev.cdn.ampproject.org/i/s/asur.dev/images/amp-ssr-en-build-time-con-github-actions/comparacion-amp-normal-vs-ssr.png width=1600><i-amphtml-sizer style=display:block;padding-top:30.0000%;></i-amphtml-sizer></amp-img></figure><p>La única opción es automatizarlo con un script que busque los elementos en el DOM y les aplique los cambios necesarios.</p><p>Para esto ya existen dos librerías open source:</p><ul><li><a href=https://www.npmjs.com/package/amp-toolbox-optimizer target=_top>AMP Optimizer</a>: Escrita en JavaScript, se puede descargar e instalar por NPM. También cuenta con un middleware para Express.</li><li><a href=https://github.com/ampproject/amppackager/tree/releases/transformer/ target=_top>AMP Packager</a>: Escrita en Golang, algo más rápida. Requiere de <em>Signed exchages</em> para que los cambios sean válidos.</li></ul><p>Estas librerías no solo eliminan el boilerplate de AMP, hacen más cosas, como <strong>dns-prefetchs automáticos</strong>, elimina comentarios y muchas más (<a href=https://github.com/ampproject/amphtml/blob/master/spec/amp-cache-modifications.md target=_top>Lista completa de cambios</a>).</p><p>Si te interesa puedes ver una <a href=https://blog.amp.dev/2018/10/08/how-to-make-amp-even-faster/ target=_top>comparativa de rendimiento detallada</a> en el blog oficial de AMP, en el que comparan cifras antes y después en distintos escenarios.</p><p><strong>DATO CURIOSO</strong>: Este mismo procesado lo realiza Google sobre tu AMP antes de guardarlo en su cache, lo que le da esa sensación de carga instantanea.</p><h2 id=creación-y-despliegue-en-github-actions>Creación y despliegue en GitHub Actions 😺</h2><p>Vale, una vez ya me he informado y leído sobre el tema tengo claro que <strong>lo quiero en mi blog</strong>.</p><p>Según ponen en la documentación, <strong>la manera ideal de aplicar las tranformaciones en en build time</strong>, dejando como alternativa menos recomendable tranformar y cachear los request <em>on the fly</em>.</p><p>Como algunos ya sabréis, para buildear y desplegar mi blog utilizo GitHub Actions, pero no había ninguna en el Marketplace que hiciese esto, así que decidí hacer la mía propia y publicarla! 🤓</p><h3 id=script-de-bash>Script de bash</h3><p>La primera decisión es cual de las dos librerías utilizo. Cloudflare ya da la opción de habilitar <em>signed exchages</em> para AMP, así que elijo la librería de Go ya que no tengo esa limitación y soy un poco <em>fanboy</em>, no te voy a engañar.</p><p>Al empezar a probar la librería me encuentro con dos problemas:</p><ul><li>El contenido formateado se escribe en <em>stdout</em> y no hay una opción en el comando para que modificase el fichero directamente.</li><li>No solo cuento con un fichero, si no con N y encima en un directorio sin una estructura concreta, así que necesito algún tipo de recursividad.</li></ul><p>Esta es a la solución a la que he llegado utilizando un script de bash:</p><div class=highlight><div class=chroma><table class=lntable><tbody><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span>
<span class=k>for</span> file in <span class=k>$(</span>find <span class=si>${</span><span class=nv>INPUT_ROOT</span><span class=si>}</span> -name <span class=s2>&#34;*.html&#34;</span><span class=k>)</span><span class=p>;</span> <span class=k>do</span>
    <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=nb>break</span>
    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=s2>Optimizing </span><span class=nv>$file</span><span class=s2>&#34;</span>
    ! <span class=nv>$GOPATH</span>/bin/transform <span class=nv>$file</span> &gt; /tmp/optimized.txt
    <span class=o>[</span> -s /tmp/optimized.txt <span class=o>]</span> <span class=o>&amp;&amp;</span> cat /tmp/optimized.txt &gt; <span class=nv>$file</span> <span class=se>\
</span><span class=se></span>      <span class=o>||</span> <span class=nb>echo</span> <span class=s2>&#34;Not a valid AMP page. Omitting...&#34;</span>
<span class=k>done</span></code></pre></td></tr></tbody></table></div></div><p>Con el comando <code>find</code> puedo buscar recursivamente todos los ficheros con la extensión <code>html</code>.</p><p>Ejecuto el transformador y pongo el contenido en un fichero intermedio. Puede parecer un paso innecesario, pero resulta que <code>$GOPATH/bin/transform $file | &gt; $file</code> no funciona, necesito un buffer!</p><p>Una vez guardado el contenido en el fichero temporal ya se puede sobreescribir el fichero original!</p><p>Con esta base ya puedo empezar a pensar en como integrarlo en una Action de verdad.</p><h3 id=dockerización>Dockerización</h3><p>Hay dos opciones para crear una GitHub Actions, que se base en una imagen de docker o que ejecute javascript.</p><p>He elegido la primera porque al utilizar solo bash me es más cómodo y el build time de mi contenedor es mínimo, pero si que normalmente <strong>la opción de javascript se ejecuta más rápido</strong> al no necesitar construir una imagen.</p><p>Para el <em>Dockerfile</em> me he limitado a instalar el paquete del tranformadora y empaquetar el script anterior de bash en un <code>entrypoint.sh</code>. Así queda mi extensísimo fichero:</p><div class=highlight><div class=chroma><table class=lntable><tbody><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=k>FROM</span><span class=s> golang:latest</span><span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>RUN</span> go get -u github.com/ampproject/amppackager/cmd/transform<span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>COPY</span> entrypoint.sh /entrypoint.sh<span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span> <span class=s2>&#34;/entrypoint.sh&#34;</span> <span class=p>]</span></code></pre></td></tr></tbody></table></div></div><h3 id=publicación-en-el-marketplace>Publicación en el marketplace</h3><p>A la hora de publicar el proyecto en el marketplace de GitHub necesitas pasar ciertas validaciones. Lo más importante es tener tu action documentada en el <code>README.md</code> al menos con los parámetros aceptados y un ejemplo de uso.</p><p>También necesitas un fichero de configuración:</p><div class=highlight><div class=chroma><table class=lntable><tbody><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml>name<span class=p>:</span><span class=w> </span><span class=s1>&#39;AMP optimizer action&#39;</span><span class=w>
</span><span class=w></span>description<span class=p>:</span><span class=w> </span><span class=s1>&#39;GitHub Action to optimize AMP HTML files :zap:
</span><span class=s1>  It uses AMP Transformer library. Designed for static web generator pipelines.&#39;</span><span class=w>
</span><span class=w></span>author<span class=p>:</span><span class=w> </span><span class=s1>&#39;asurbernardo&#39;</span><span class=w>
</span><span class=w></span>runs<span class=p>:</span><span class=w>
</span><span class=w>  </span>using<span class=p>:</span><span class=w> </span><span class=s1>&#39;docker&#39;</span><span class=w>
</span><span class=w>  </span>image<span class=p>:</span><span class=w> </span><span class=s1>&#39;Dockerfile&#39;</span><span class=w>
</span><span class=w></span>branding<span class=p>:</span><span class=w>
</span><span class=w>  </span>icon<span class=p>:</span><span class=w> </span><span class=s1>&#39;battery-charging&#39;</span><span class=w>
</span><span class=w>  </span>color<span class=p>:</span><span class=w> </span><span class=s1>&#39;yellow&#39;</span><span class=w>
</span><span class=w></span>inputs<span class=p>:</span><span class=w>
</span><span class=w>  </span>root<span class=p>:</span><span class=w>
</span><span class=w>    </span>description<span class=p>:</span><span class=w> </span><span class=s1>&#39;The root directory to start the search from&#39;</span><span class=w>
</span><span class=w>    </span>required<span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>    </span>default<span class=p>:</span><span class=w> </span><span class=s1>&#39;.&#39;</span></code></pre></td></tr></tbody></table></div></div><p>Con esto ya está todo listo! Podemos crear una versión de nuestro proyecto en GitHub y <a href=https://github.com/marketplace/actions/amp-optimizer-action target=_top>publicarla en el marketplace</a>!</p><p>Ahora cualquier persona que quiera utilizarla en su proceso de despliegue lo único que tiene que añadir es un <em>step</em> a su fichero <code>yml</code> como este:</p><div class=highlight><div class=chroma><table class=lntable><tbody><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>- name: Optimize AMP
  uses: asurbernardo/amp-optimizer-action@1.0.2
  with:
    root: <span class=s1>&#39;./public&#39;</span></code></pre></td></tr></tbody></table></div></div><p>CLAP! CLAP! CLAP! 👏</p><h2 id=próximo-destino>Próximo destino 🛣️</h2><p>Ahora si que si, he tardado un poco más de lo que pensaba en preparar el siguiente post pero confirmo que voy a estrenar la sección en inglés con un post piloto sobre monetización online. <em>Stay tuned!</em> 😎 🇬🇧</p><h2 class=related-content__title>Lecturas relacionadas 📖</h2><p class=related-content__item><a data-rel=prefetch href=https://asur.dev/metablogs/pwa-en-amp-con-service-worker-e-i18n/ target=_top>Metablog #6 - PWA y soporte multi-idioma</a></p><p class=related-content__item><a data-rel=prefetch href=https://asur.dev/metablogs/mejorando-workflow-docker-makefile-github-actions/ target=_top>Metablog #3 - Workflow con docker, makefile y Github actions</a></p><p class=related-content__item><a data-rel=prefetch href=https://asur.dev/metablogs/nuevo-dominio-legibilidad-integracion-amp-scripts/ target=_top>Metablog #4 - Nuevo dominio, nuevo layout y más AMP!</a></p><section class=author><p class=author__name>Asur Bernardo</p><amp-img class="author__image i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=200 i-amphtml-layout=fixed layout=fixed src=https://asur.dev/images/me.jpg style=width:200px;height:200px; width=200></amp-img><p class=author__bio>Back end developer sin ningún tipo de gusto estético. Me encanta el cacharreo y la tecnología. Siempre intento aprender cosas nuevas.</p><p class=author__cta>✨ ¡Si te ha costado comparte y comenta! ✨</p><div class=social-share><amp-social-share aria-label="Compartir contenido" class="social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=system width=50></amp-social-share><amp-social-share aria-label="Compartir en Facebook" class="social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=facebook width=50></amp-social-share><amp-social-share aria-label="Compartir en Twitter" class="social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=twitter width=50></amp-social-share><amp-social-share aria-label="Compartir en Linkedin" class="social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=linkedin width=50></amp-social-share><amp-social-share aria-label="Compartir en Pinterest" class="social-share__button i-amphtml-layout-fixed i-amphtml-layout-size-defined" height=50 i-amphtml-layout=fixed style=width:50px;height:50px; type=pinterest width=50></amp-social-share></div></section><amp-iframe class="i-amphtml-layout-responsive i-amphtml-layout-size-defined" height=180 i-amphtml-layout=responsive layout=responsive resizable sandbox="allow-scripts allow-same-origin allow-modals allow-popups allow-forms" src="https://comments.asur.dev?id=5f163ee5ac2d3ed3d9e4bae1a7f15bb9&amp;url=https%3a%2f%2fasur.dev%2fmetablogs%2fssr-de-amp-en-build-time-con-github-actions%2f" width=600><i-amphtml-sizer style=display:block;padding-top:30.0000%;></i-amphtml-sizer><div aria-label="Load more" overflow role=button style="display:block;font-size:14px;font-weight:500;text-align:center;line-height:1.1;padding:12px 16px;border-radius:4px;background:rgba(29,47,58,.6);color:#fff" tabindex=0>Load more</div></amp-iframe></article></main><footer class=footer><div class=footer__copyright>© asur.dev 2020</div><div class=footer__languages><b>Español</b>
<a data-rel=prefetch href=https://asur.dev/en target=_top>English</a></div></footer></body></html>
